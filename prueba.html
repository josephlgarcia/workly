<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Solicitud de Permiso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body class="bg-light">

    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="card p-4 shadow-lg" style="width: 100%; max-width: 500px;">
            <div class="card-body">
                <h1 class="card-title text-center text-dark mb-4">Solicitud de Permiso</h1>

                <form id="leaveForm" class="row g-3" enctype="multipart/form-data">
                    <div class="col-12">
                        <label for="employee_id" class="form-label">ID del Empleado</label>
                        <select id="employee_id" name="employee_id" required class="form-select">
                            <option value="">Cargando empleados...</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label for="leave_type_id" class="form-label">Tipo de Permiso</label>
                        <select id="leave_type_id" name="leave_type_id" required class="form-select">
                            <option value="">Cargando tipos de permiso...</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label for="start_day" class="form-label">Fecha de Inicio</label>
                        <input type="date" id="start_day" name="start_day" required class="form-control">
                    </div>

                    <div class="col-12">
                        <label for="end_day" class="form-label">Fecha de Fin</label>
                        <input type="date" id="end_day" name="end_day" required class="form-control">
                    </div>

                    <div class="col-12">
                        <label for="description" class="form-label">Descripción</label>
                        <textarea id="description" name="description" rows="3" required class="form-control"></textarea>
                    </div>

                    <div class="col-12">
                        <label for="leave_file" class="form-label">Archivo Adjunto (Opcional)</label>
                        <input type="file" id="leave_file" name="leave_file" class="form-control">
                    </div>
                    
                    <input type="hidden" name="leave_status_id" value="3">

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary w-100">
                            Enviar Solicitud
                        </button>
                    </div>
                </form>

                <div id="message" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>


    <script>
        const form = document.getElementById('leaveForm');
        const messageDiv = document.getElementById('message');
        const startDayInput = document.getElementById('start_day');
        const endDayInput = document.getElementById('end_day');
        const employeeSelect = document.getElementById('employee_id');
        const leaveTypeSelect = document.getElementById('leave_type_id');

        // Función para llenar un select con datos
        const populateSelect = (selectElement, data, valueKey, textKey) => {
            // Elimina la opción de "Cargando..."
            selectElement.innerHTML = '';
            
            // Crea una opción por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Seleccione una opcion';
            selectElement.appendChild(defaultOption);

            // Llena el select con los datos
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                selectElement.appendChild(option);
            });
        };

        // Función para obtener los empleados desde la API
        const fetchEmployees = async () => {
            try {
                const response = await fetch('http://localhost:3001/api/v1/employee');
                const employees = await response.json();
                populateSelect(employeeSelect, employees, 'id_employee', 'full_name');
            } catch (error) {
                console.error('Error fetching employees:', error);
                employeeSelect.innerHTML = '<option value="">Error al cargar empleados</option>';
            }
        };

        // Función para obtener los tipos de permiso desde la API
        const fetchLeaveTypes = async () => {
            try {
                const response = await fetch('http://localhost:3001/api/v1/leaves-type');
                const leaveTypes = await response.json();
                populateSelect(leaveTypeSelect, leaveTypes, 'id_leave_type', 'name'); // El campo es 'name'
            } catch (error) {
                console.error('Error fetching leave types:', error);
                leaveTypeSelect.innerHTML = '<option value="">Error al cargar tipos de permiso</option>';
            }
        };

        // Escucha los cambios en la fecha de inicio
        startDayInput.addEventListener('change', () => {
            // Establece la fecha mínima de la fecha de fin como la fecha de inicio
            endDayInput.min = startDayInput.value;
            // Si la fecha de fin actual es anterior a la nueva fecha de inicio, la borra
            if (endDayInput.value < startDayInput.value) {
                endDayInput.value = startDayInput.value;
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Resetea el mensaje de estado
            messageDiv.textContent = '';
            messageDiv.className = 'mt-4 text-center';

            // Crea un objeto FormData a partir del formulario
            const formData = new FormData(form);

            try {
                const response = await fetch('http://localhost:3001/api/v1/leave', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.textContent = result.message;
                    messageDiv.classList.add('text-green-600');
                    form.reset(); // Limpia el formulario si la solicitud fue exitosa
                } else {
                    messageDiv.textContent = result.message || 'Error desconocido';
                    messageDiv.classList.add('text-red-600');
                }
            } catch (error) {
                console.error('Error:', error);
                messageDiv.textContent = 'Error al conectar con el servidor.';
                messageDiv.classList.add('text-red-600');
            }
        });

        // Llama a las funciones para poblar los select al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            fetchEmployees();
            fetchLeaveTypes();
        });
    </script>
</body>
</html>
